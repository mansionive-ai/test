<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>이야기 페이지</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: system-ui, -apple-system, Roboto, 'Noto Sans KR', sans-serif;
    background: linear-gradient(120deg,#0f172a,#0b1220);
    color: #fff;
  }
  .wrap {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    padding: 2rem;
  }
  .card {
    background: none;
    backdrop-filter: none;
    padding: 0;
    box-shadow: none;
  }
  audio { display: none; }

  #backBtn {
    position: fixed;
    top: 5px;
    left: 5px;
    padding: 8px 16px;
    font-size: 18px;
    z-index: 1000;
    background: rgba(51, 65, 85, 0.8);
    border: none;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #backBtn:hover {
    background: rgba(71, 85, 105, 0.9);
  }

  #continueBtn {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: #3b82f6;
    border: none;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
  }
  #continueBtn:hover {
    background: #2563eb;
  }

  #codeInput {
    padding: 0.75rem;
    font-size: 16px;
    border: 2px solid #475569;
    border-radius: 6px;
    background: #1e293b;
    color: #fff;
    margin-top: 1rem;
    width: 200px;
    text-align: center;
  }
  #codeInput:focus {
    outline: none;
    border-color: #3b82f6;
  }

  #submitBtn {
    margin-top: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #10b981;
    border: none;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
  }
  #submitBtn:hover {
    background: #059669;
  }

  #msg {
    margin-top: 0.5rem;
    opacity: 0.8;
    color: #ef4444;
    font-weight: bold;
  }

  .choice-btn {
    display: block;
    margin: 0.75rem auto;
    padding: 0.75rem 1.5rem;
    background: #6366f1;
    border: none;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
    min-width: 250px;
  }
  .choice-btn:hover {
    background: #4f46e5;
  }

  video {
    max-width: 100%;
    border-radius: 8px;
  }
</style>
</head>
<body>

<button id="backBtn">←</button>

<div class="wrap">
  <div class="card" id="card"></div>

  <audio id="bgm" loop preload="auto">
    <source src="./bgm.mp3" type="audio/mpeg">
  </audio>
  <audio id="sfx" preload="auto"></audio>
</div>

<div id="confirmPopup" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);
  align-items:center; justify-content:center; z-index:2000;">

  <div style="background:#1e293b; padding:30px; border-radius:12px; text-align:center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <p style="font-size:18px; margin-bottom:20px;">이어하기가 존재합니다.<br>정말로 새로 시작합니까?</p>
    <button id="yesBtn" style="margin-right:10px; padding:10px 20px; background:#ef4444; border:none; color:#fff; border-radius:6px; cursor:pointer; font-size:16px;">네</button>
    <button id="noBtn" style="padding:10px 20px; background:#6b7280; border:none; color:#fff; border-radius:6px; cursor:pointer; font-size:16px;">아니요</button>
  </div>
</div>

<script>
const audio = document.getElementById('bgm');
const sfx = document.getElementById('sfx');
const wrap = document.querySelector('.wrap');

let currentPage = 0;
let pageHistory = [];  // 페이지 히스토리 추적
let audioUnlocked = false;  // 오디오 잠금 해제 여부

const pages = {
  0: "클릭하여 시작<br>",
  1: '"정신차리세요~"',
  2: '"드디어 일어나셨군요."',
  3: '눈을 뜨자 처음 보는 여자가 나를 뚫어져라 바라보고 있었다.',
  4: '"몸은 괜찮으신가요?"',
  5: '"네"<br><br>나는 정신없이 그녀의 질문에 답하며 주변을 둘러보았다.',
  6: '끝없이 이어지는 노란색 벽과, 형광등 불빛만이 허공에 떠있다.',
  7: '눅눅하고 축축한 공기, 사방에 길고 길게 이어진 복도는 끝없이 늘어져 있다.',
  8: '주위는 웅웅거리는 소리뿐, 공허하게 울리는 내 목소리는 마치 세상과 단절된 것처럼 느껴진다.',
  9: '"저도 눈을 떠보니 이런 알 수 없는 공간에 있었어요."',
  10: '"아, 제 이름은 일레이나예요."',
  11: '그녀는 자신을 일레이나라고 소개했다.<br><br>"저는.."',
  12: '나는.. 누구지?',
  13: '내 머릿속은 텅텅 빈 듯 아무것도 기억나지 않았다.',
  14: '일레이나씨는 나를 걱정하는 듯 보인다.',
  15: '"어디 안좋으세요..?"',
  16: '"놀랍게도 저에 대해서 기억이 나지 않아요."',
  17: '"기억상실인가요? <br><br>이 공간에 올 때 머리를 부딪치셨을지도 모르겠어요."',
  18: '"...... ."',
  19: '"저도 똑같은 것 같아요."',
  20: '"제가 어쩌다가 이곳에 왔는지, 뭘 하던 사람인지, 아무것도 모르겠어요."',
  21: '"저는 그래도 제 이름은 기억하네요."',
  22: '일레이나씨도 기억이 혼란스러운 모양이다.',
  23: '가만히 구조를 기다려야 할까?',
  24: '아니다, 지금 상황은 아무리 봐도 정상이 아니다.',
  25: '"...... ."',
  26: '"한곳에 가만히 있기도 좀 그러니 움직이겠어요?"',
  27: '"네."<br><br>나와 일레이나씨는 같이 움직이기 시작했다.',
  28: '끝없이 이어지는 같은 풍경, 마치 미로처럼 느껴진다.',
  29: '2분 정도 지났을까? 두 사람은 아무말 없이 발을 맞춰 걸어나갔다.',
  30: '"끝이 없네요."',
  31: '"그러게요."<br><br>약간 어색한 분위기에서 일레이나씨가 나에게 고개를 돌리며 말했다.',
  32: '"어?"',
  33: '일레이나씨는 뭔가를 보고 멈추었다.',
  34: '"이게 뭘까요?"',
  35: '벽지에 무언가 적혀있다.<br><br> 이건 숫자 관련된 문제일까?',
  36: '"?에 들어갈 숫자를 찾으라는 것 같네요."',
  37: '나는 왠지 모르게 간단히 풀 수 있을 것 같았다.',
  38: '?에 들어갈 숫자, 분명 규칙이 있을 것이다.',
  39: '"정답은 576이네요."',
  40: '"풀이가 뭔가요?"',
  41: '"8단입니다."',
  42: '"팔 일은 팔 팔 이 십육 팔 삼에 이십사"',
  43: '"..!"',
  44: '"그렇죠?"',
  45: '"저는 그런 발상조차도 못했어요. 대단하세요."',
  46: '"아닙니다. 이런건 기억이 나는 법이군요."<br><br>나는 어색하게 웃으며 말했다.',
  47: '후.. 위험했다. 나는 여자에 약한 타입인가? 웃는 모습 너무 예쁘잖아..!',
  48: '객관적으로 보나 주관적으로 보나 일레이나씨는 굉장한 미인이다.<br><br>그래서 그런건지 내성적인 성격 때문인지 쑥스러운 탓에 말이 잘 안나온다.',
  49: '"왜 그러세요?"',
  50: '"576은 혹시 모르니 기억해 놓죠."',
  51: '"그게 좋겠어요."',
  52: 'chapter 1<br><br>『백룸』'
};

const pageImages = {
  0: "./Dream Time.jpg",
  2: "./기본.jpg",
  4: "./기본.jpg",
  6: "./백룸.jpg",
  7: "./백룸.jpg",
  8: "./백룸.jpg",
  9: "./시크.jpg",
  10: "./기본.jpg",
  15: "./기본.jpg",
  17: "./기본.jpg",
  18: "./시크.jpg",
  19: "./걱정.jpg",
  20: "./기본.jpg",
  21: "./시크.jpg",
  25: "./시크.jpg",
  26: "./기본.jpg",
  30: "./일어남.jpg",
  32: "./일어남.jpg",
  34: "./기본2.jpg",
  35: "./첫문제.jpg",
  36: "./첫문제.jpg",
  37: "./첫문제.jpg",
  38: "./첫문제.jpg",
  40: "./기본2.jpg",
  42: "./기본2.jpg",
  43: "./놀람.jpg",
  45: "./미소.jpg",
  49: "./기본2.jpg",
  51: "./기본.jpg"
};

const pageImageStyles = {
  0: "width:350px; margin-top:10px;",
  1: "width:250px; margin-top:0px; transform:translateX(-240px);",
  2: "width:250px; margin-top:-100px;",
  3: "width:250px; margin-top:-100px;",
  4: "width:250px; margin-top:-100px;",
  5: "width:250px; margin-top:-100px;",
  6: "width:250px; margin-top:-100px;",
  7: "width:250px; margin-top:-100px;",
  8: "width:250px; margin-top:-100px;",
  9: "width:250px; margin-top:-100px;",
  10: "width:250px; margin-top:-100px;",
  15: "width:250px; margin-top:-100px;",
  17: "width:250px; margin-top:-100px;",
  18: "width:250px; margin-top:-100px;",
  19: "width:250px; margin-top:-100px;",
  20: "width:250px; margin-top:-100px;",
  21: "width:250px; margin-top:-100px;",
  25: "width:250px; margin-top:-100px;",
  26: "width:250px; margin-top:-100px;",
  30: "width:250px; margin-top:-100px;",
  32: "width:250px; margin-top:-100px;",
  34: "width:250px; margin-top:-100px;",
  35: "width:250px; margin-top:-100px;",
  36: "width:250px; margin-top:-100px;",
  37: "width:250px; margin-top:-100px;",
  38: "width:250px; margin-top:-100px;",
  40: "width:250px; margin-top:-100px;",
  42: "width:250px; margin-top:-100px;",
  43: "width:250px; margin-top:-100px;",
  45: "width:250px; margin-top:-100px;",
  49: "width:250px; margin-top:-100px;",
  51: "width:250px; margin-top:-100px;"
};

const pageTextStyles = {
  0: "margin-top:1rem;",
  1: "margin-top:0px;",
  2: "margin-top:50px;",
  3: "margin-top:0px;",
  4: "margin-top:50px;",
  5: "margin-top:0px;",
  6: "margin-top:50px;",
  7: "margin-top:50px;",
  8: "margin-top:50px;",
  9: "margin-top:50px;",
  10: "margin-top:50px;",
  11: "margin-top:0px;",
  12: "margin-top:0px;",
  15: "margin-top:50px;",
  17: "margin-top:50px;",
  18: "margin-top:50px;",
  19: "margin-top:50px;",
  20: "margin-top:50px;",
  21: "margin-top:50px;",
  22: "margin-top:0px;",
  23: "margin-top:0px;",
  24: "margin-top:0px;",
  25: "margin-top:50px;",
  26: "margin-top:50px;",
  27: "margin-top:0px;",
  28: "margin-top:0px;",
  29: "margin-top:0px;",
  30: "margin-top:50px;",
  31: "margin-top:0px;",
  32: "margin-top:50px;",
  33: "margin-top:0px;",
  34: "margin-top:50px;",
  35: "margin-top:50px;",
  36: "margin-top:50px;",
  37: "margin-top:50px;",
  38: "margin-top:50px;",
  39: "margin-top:0px;",
  40: "margin-top:50px;",
  41: "margin-top:0px;",
  42: "margin-top:50px;",
  43: "margin-top:50px;",
  44: "margin-top:0px;",
  45: "margin-top:50px;",
  46: "margin-top:0px;",
  47: "margin-top:0px;",
  48: "margin-top:0px;",
  49: "margin-top:50px;",
  50: "margin-top:0px;",
  51: "margin-top:50px;",
  52: "margin-top:-100px;",
  53: "margin-top:0px;",
  54: "margin-top:0px;"
};

const pageCodes = {
  38: "576"
};

// 페이지별 선택지
const pageChoices = {
  3: [
    { text: "주변을 살펴본다", goto: 4 },
    { text: "일레이나에게 말을 건다", goto: 4 }
  ]
};

const pageBGMs = {
  51: "./bgm3.mp3",
  52: "./bgm3.mp3"
};

// 페이지별 효과음
const pageSFX = {
  3: "./wake_up.mp3",
  10: "./introduce.mp3",
  35: "./puzzle.mp3",
  39: "./correct.mp3",
  52: "./chapter.mp3"
};

// 페이지별 영상
const pageVideos = {
  4: "./영상.mp4"
};

// 페이지별 영상 스타일
const pageVideoStyles = {
  4: "width:500px; margin-top:20px;"
};

function showConfirmPopup() {
  const popup = document.getElementById("confirmPopup");
  popup.style.display = "flex";

  document.getElementById("yesBtn").onclick = () => {
    localStorage.removeItem("currentPage");
    localStorage.removeItem("pageHistory");
    currentPage = 1;
    pageHistory = [];
    popup.style.display = "none";
    showPage();
  };

  document.getElementById("noBtn").onclick = () => {
    popup.style.display = "none";
  };
}

function showPage() {
  const card = document.getElementById('card');
  const backBtn = document.getElementById("backBtn");
  const saved = localStorage.getItem("currentPage");

  if (currentPage === 0) backBtn.style.display = "none";
  else backBtn.style.display = "block";

  if (currentPage === 0) {
    card.innerHTML = `
      <img src="./Dream Time.jpg" style="width:350px; margin-top:10px;">
      <p style="margin-top:1rem;">클릭하여 시작<br></p>
      ${saved && saved > 0 ? `<button id="continueBtn">이어하기</button>` : ""}
    `;

    if (saved && saved > 0) {
      document.getElementById("continueBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        currentPage = parseInt(saved);
        // 히스토리도 복원
        const savedHistory = localStorage.getItem("pageHistory");
        if (savedHistory) {
          pageHistory = JSON.parse(savedHistory);
        }
        showPage();
      });
    }
    return;
  }

  // 페이지가 존재하지 않으면 에러 표시
  if (!pages[currentPage]) {
    card.innerHTML = `<p style="color:#ef4444;">페이지 ${currentPage}가 존재하지 않습니다.</p>`;
    return;
  }

  if (currentPage >= pages.length) {
    card.innerHTML = "마지막 페이지입니다.";
    return;
  }

  // BGM 변경
  if (pageBGMs[currentPage]) {
    audio.pause();
    audio.src = pageBGMs[currentPage];
    audio.play().catch(() => {});
  }

  // 효과음 재생
  if (pageSFX[currentPage]) {
    sfx.src = pageSFX[currentPage];
    sfx.play().catch(() => {});
  }

  // 선택지 페이지
  if (pageChoices[currentPage]) {
    let choicesHTML = '';
    pageChoices[currentPage].forEach((choice, index) => {
      choicesHTML += `<button class="choice-btn" data-goto="${choice.goto}">${choice.text}</button>`;
    });

    card.innerHTML = `
      ${pageVideos[currentPage] ? `<video id="pageVideo" loop style="${pageVideoStyles[currentPage] || 'width:500px;'}"><source src="${pageVideos[currentPage]}" type="video/mp4"></video>` : ""}
      ${pageImages[currentPage] ? `<img src="${pageImages[currentPage]}" style="${pageImageStyles[currentPage]}">` : ""}
      <p style="${pageTextStyles[currentPage]}">${pages[currentPage]}</p>
      <div style="margin-top: 1.5rem;">
        ${choicesHTML}
      </div>
    `;

    // 영상이 있으면 재생
    if (pageVideos[currentPage]) {
      const video = document.getElementById('pageVideo');
      if (video) {
        video.muted = !audioUnlocked;  // 잠금 해제 여부에 따라
        video.play().catch(() => {
          // 실패하면 음소거로 재생
          video.muted = true;
          video.play().catch(() => {});
        });
      }
    }

    // 선택지 버튼 이벤트
    document.querySelectorAll('.choice-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        pageHistory.push(currentPage);
        currentPage = parseInt(btn.dataset.goto);
        localStorage.setItem("currentPage", currentPage);
        localStorage.setItem("pageHistory", JSON.stringify(pageHistory));
        showPage();
      });
    });
    return;
  }

  if (pageCodes[currentPage]) {
    card.innerHTML = `
      ${pageVideos[currentPage] ? `<video id="pageVideo" loop style="${pageVideoStyles[currentPage] || 'width:500px;'}"><source src="${pageVideos[currentPage]}" type="video/mp4"></video>` : ""}
      ${pageImages[currentPage] ? `<img src="${pageImages[currentPage]}" style="${pageImageStyles[currentPage]}">` : ""}
      <p style="${pageTextStyles[currentPage]}">${pages[currentPage]}</p>
      <input type="text" id="codeInput" placeholder="코드입력"><br>
      <button id="submitBtn">확인</button>
      <p id="msg"></p>
    `;

    // 영상이 있으면 재생
    if (pageVideos[currentPage]) {
      const video = document.getElementById('pageVideo');
      if (video) {
        video.muted = !audioUnlocked;
        video.play().catch(() => {
          video.muted = true;
          video.play().catch(() => {});
        });
      }
    }

    const codeInput = document.getElementById('codeInput');
    const submitBtn = document.getElementById('submitBtn');

    const checkCode = (e) => {
      e.stopPropagation();
      const entered = codeInput.value.trim();
      const msg = document.getElementById('msg');
      if (entered === pageCodes[currentPage]) {
        currentPage++;
        localStorage.setItem("currentPage", currentPage);
        showPage();
      } else {
        msg.textContent = "코드가 틀렸습니다!";
        codeInput.value = '';
        codeInput.focus();
      }
    };

    submitBtn.addEventListener('click', checkCode);
    
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkCode(e);
      }
    });

    setTimeout(() => codeInput.focus(), 100);

  } else {
    card.innerHTML = `
      ${pageVideos[currentPage] ? `<video id="pageVideo" loop style="${pageVideoStyles[currentPage] || 'width:500px;'}"><source src="${pageVideos[currentPage]}" type="video/mp4"></video>` : ""}
      ${pageImages[currentPage] ? `<img src="${pageImages[currentPage]}" style="${pageImageStyles[currentPage]}">` : ""}
      <p style="${pageTextStyles[currentPage]}">${pages[currentPage]}</p>
    `;

    // 영상이 있으면 재생
    if (pageVideos[currentPage]) {
      const video = document.getElementById('pageVideo');
      if (video) {
        video.muted = !audioUnlocked;
        video.play().catch(() => {
          video.muted = true;
          video.play().catch(() => {});
        });
      }
    }
  }
}

wrap.addEventListener('click', () => {
  // 선택지나 코드 입력 페이지에서는 클릭 무시
  if (pageCodes[currentPage] || pageChoices[currentPage]) return;

  if (currentPage === 0) {
    const saved = localStorage.getItem("currentPage");

    if (saved && saved > 0) {
      showConfirmPopup();
      return;
    }

    audio.play().catch(() => {});
    audioUnlocked = true;  // 오디오 잠금 해제
    currentPage = 1;
    localStorage.setItem("currentPage", currentPage);
    showPage();
    return;
  }

  if (pages[currentPage + 1]) {
    currentPage++;
    // 일반 진행은 히스토리 초기화 (선택지 아닌 경우)
    pageHistory = [];
    localStorage.setItem("currentPage", currentPage);
    localStorage.setItem("pageHistory", JSON.stringify(pageHistory));
    showPage();
  }
});

document.getElementById("backBtn").addEventListener("click", () => {
  if (pageHistory.length > 0) {
    // 히스토리가 있으면 히스토리에서 가져오기
    currentPage = pageHistory.pop();
    localStorage.setItem("currentPage", currentPage);
    localStorage.setItem("pageHistory", JSON.stringify(pageHistory));
    showPage();
  } else if (currentPage > 0) {
    // 히스토리가 없으면 일반적인 뒤로가기
    currentPage--;
    localStorage.setItem("currentPage", currentPage);
    showPage();
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "ArrowLeft") {
    if (pageHistory.length > 0) {
      // 히스토리가 있으면 히스토리에서 가져오기
      currentPage = pageHistory.pop();
      localStorage.setItem("currentPage", currentPage);
      localStorage.setItem("pageHistory", JSON.stringify(pageHistory));
      showPage();
    } else if (currentPage > 0) {
      // 히스토리가 없으면 일반적인 뒤로가기
      currentPage--;
      localStorage.setItem("currentPage", currentPage);
      showPage();
    }
  } else if (e.key === "ArrowRight" && pages[currentPage + 1] && !pageCodes[currentPage] && !pageChoices[currentPage]) {
    currentPage++;
    localStorage.setItem("currentPage", currentPage);
    showPage();
  }
});

showPage();
</script>
</body>
</html>
